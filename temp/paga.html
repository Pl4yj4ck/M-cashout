<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PAGA</title>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .frame {
            width: 430px;
            padding: 24px;
            position: relative;
        }

        .back {
            position: absolute;
            left: 24px;
            top: 32px;
            width: 20px;
            cursor: pointer;
        }

        .header {
            display: flex;
            justify-content: center;
            font-size: 26px;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 24px;
        }

        .amount-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #e9e9e9;
            border-radius: 18px;
            padding: 16px 20px;
            margin-bottom: 28px;
        }

        .amount {
            font-size: 40px;
            font-weight: normal;
        }

        .icon-btn {
            font-size: 26px;
            cursor: pointer;
            user-select: none;
        }

        .checkout-title {
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .checkout-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkout-row span {
            width: 30px;
            font-size: 12px;
            text-transform: uppercase;
        }

        select,
        .readonly {
            flex: 1;
            background: #e9e9e9;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 14px;
            text-transform: uppercase;
            border: none;
        }

        select {
            padding-right: 36px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23000' stroke-width='2' fill='none'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .pay-btn {
            margin-top: 28px;
            width: 100%;
            padding: 14px;
            background: #7c827a;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
            border-radius: 14px;
            border: none;
            cursor: pointer;
        }

        .pay-btn:active {
            transform: scale(0.98);
        }

        /* ALERT CUSTOM */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-box {
            background: white;
            padding: 24px 28px;
            border-radius: 20px;
            width: 280px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-box p {
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        .modal-box button {
            background: #7c827a;
            color: white;
            border: none;
            padding: 10px 36px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-box button:active {
            transform: scale(0.96);
        }

        /* input per scrivere importo */
        #diInput {
            font-size: 14px;
            padding: 6px 10px;
            border-radius: 10px;
            border: none;
            width: 100%;
            text-align: left;
            box-sizing: border-box;
        }

        .clickable {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="frame">
        <img class="back" src="../img/back0.svg" alt="indietro" onclick="history.back()">

        <div class="header">PAGA</div>

        <div class="checkout-title">SELEZIONARE L’IMPORTO</div>

        <div class="amount-box">
            <div class="icon-btn" onclick="decrease()">−</div>
            <div class="amount" id="amount">M100</div>
            <div class="icon-btn" onclick="increase()">+</div>
        </div>

        <div class="checkout-title">CHECKOUT</div>

        <div class="checkout-row">
            <span>DA:</span>
            <select id="from">
                <option value="">-SELEZIONARE CHI DEVE PAGARE-</option>
            </select>
        </div>

        <div class="checkout-row">
            <span>A:</span>
            <select id="to">
                <option value="">-SELEZIONARE CHI RICEVE-</option>
                <option value="BANCA">BANCA</option>
            </select>
        </div>

        <div class="checkout-row">
            <span>DI:</span>
            <div id="diDisplay" class="readonly clickable" onclick="editAmount()">M100</div>
            <input id="diInput" type="number" min="10" step="10" hidden onblur="confirmAmount()" onkeydown="handleEnter(event)">
        </div>

        <button class="pay-btn" onclick="pay()">PAGA</button>
    </div>

    <!-- ALERT -->
    <div id="customAlert" class="modal hidden">
        <div class="modal-box">
            <p id="alertText"></p>
            <button onclick="closeAlert()">OK</button>
        </div>
    </div>

    <script>
    let value = 100;

    function updateUI() {
        document.getElementById("amount").innerText = "M" + value;
        document.getElementById("diDisplay").innerText = "M" + value;
    }

    function increase() {
        value += 10;
        updateUI();
    }

    function decrease() {
        if (value > 10) value -= 10;
        updateUI();
    }

    // Scrivere importo con tastiera
    function editAmount() {
        const display = document.getElementById("diDisplay");
        const input = document.getElementById("diInput");
        input.value = value;
        display.hidden = true;
        input.hidden = false;
        input.focus();
        input.select();
    }

    function confirmAmount() {
        const input = document.getElementById("diInput");
        let newValue = parseInt(input.value);
        if (!isNaN(newValue) && newValue >= 10) {
            value = newValue;
            updateUI();
        }
        input.hidden = true;
        document.getElementById("diDisplay").hidden = false;
    }

    function handleEnter(event) {
        if (event.key === "Enter") {
            confirmAmount();
        }
    }

    // ALERT
    function showAlert(text) {
        document.getElementById("alertText").innerText = text;
        document.getElementById("customAlert").classList.remove("hidden");
    }

    function closeAlert() {
        document.getElementById("customAlert").classList.add("hidden");
    }

    // POPOLA SELECT CON PEDINE DAL LOCALSTORAGE
    let saldi = JSON.parse(localStorage.getItem("saldi")) || {};
    const selectFrom = document.getElementById("from");
    const selectTo = document.getElementById("to");

    function refreshSelects() {
        // svuota le select tranne BANCA
        selectFrom.innerHTML = '<option value="">-SELEZIONARE CHI DEVE PAGARE-</option>';
        selectTo.innerHTML = '<option value="">-SELEZIONARE CHI RICEVE-</option><option value="BANCA">BANCA</option>';

        Object.keys(saldi).forEach(nome => {
            const opt1 = document.createElement("option");
            opt1.value = nome;
            opt1.textContent = nome;
            selectFrom.appendChild(opt1);

            const opt2 = document.createElement("option");
            opt2.value = nome;
            opt2.textContent = nome;
            selectTo.appendChild(opt2);
        });
    }

    refreshSelects(); // inizializza le select

    // PAGA
    function pay() {
    const from = selectFrom.value;
    const to = selectTo.value;

    if (!from) { showAlert("SELEZIONA CHI DEVE PAGARE"); return; }
    if (!to) { showAlert("SELEZIONA CHI DEVE RICEVERE"); return; }
    if (!saldi[from]) { showAlert(from + " non ha saldo."); return; }

    // Aggiorna saldo del pagatore anche se diventa negativo
    saldi[from] -= value;

    // Aggiorna saldo destinatario se non è BANCA
    if (to !== "BANCA") {
        if (!saldi[to]) saldi[to] = 0;
        saldi[to] += value;
    }

    let eliminated = []; // pedine da eliminare
    for (let nome of Object.keys(saldi)) {
        if (saldi[nome] <= 0) {
            eliminated.push(nome);
            delete saldi[nome];
        }
    }

    localStorage.setItem("saldi", JSON.stringify(saldi));
    refreshSelects(); // aggiorna select dopo eventuali eliminazioni

    // Mostra alert di pagamento + eventuali eliminazioni
    let alertMsg = "Pagamento effettuato con successo!";
    if (eliminated.length > 0) {
        alertMsg += "\nEliminati: " + eliminated.join(", ");
    }
    showAlert(alertMsg);

    setTimeout(() => window.location.href = "game.html", 3000);
}


    // Inizializza UI
    updateUI();
</script>


</body>

</html>
